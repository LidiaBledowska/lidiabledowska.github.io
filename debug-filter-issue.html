<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Filter Issue</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .debug-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .debug-button:hover {
            background: #0056b3;
        }

        .debug-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .success {
            color: #155724;
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .warning {
            color: #856404;
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .info {
            color: #0c5460;
            background: #d1ecf1;
            border-color: #bee5eb;
        }
    </style>
</head>

<body>
    <h1>üîç Debug Filter Issue</h1>
    <p>This tool helps diagnose why applications might not be appearing after submission.</p>

    <div class="debug-section">
        <h3>üéØ Quick Tests</h3>
        <button class="debug-button" onclick="checkCurrentFilters()">Check Current Filters</button>
        <button class="debug-button" onclick="testApplicationMatching()">Test Application Matching</button>
        <button class="debug-button" onclick="simulateNewApplication()">Simulate New Application</button>
        <button class="debug-button" onclick="checkRealTimeListener()">Check Real-time Listener</button>
        <button class="debug-button" onclick="clearAllAndTest()">Clear All Filters & Test</button>
        <div id="quickTestOutput" class="debug-output info" style="display: none;"></div>
    </div>

    <div class="debug-section">
        <h3>üìä Filter Analysis</h3>
        <div id="filterAnalysis" class="debug-output" style="min-height: 100px;">
            Click "Check Current Filters" to analyze filter state
        </div>
    </div>

    <div class="debug-section">
        <h3>üîÑ Real-time Listener Status</h3>
        <div id="listenerStatus" class="debug-output" style="min-height: 100px;">
            Click "Check Real-time Listener" to check listener status
        </div>
    </div>

    <div class="debug-section">
        <h3>üß™ Application Matching Test</h3>
        <div id="matchingTest" class="debug-output" style="min-height: 100px;">
            Click "Test Application Matching" to test filter logic
        </div>
    </div>

    <!-- Firebase imports -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getFirestore, collection, query, where, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD7ZLyDHFBNsQe9j03YPi0xmdLbqdk_K68",
            authDomain: "rekrutracker-app.firebaseapp.com",
            projectId: "rekrutracker-app",
            storageBucket: "rekrutracker-app.firebasestorage.app",
            messagingSenderId: "758407291898",
            appId: "1:758407291898:web:a573e2cd3b416596d37a43",
            measurementId: "G-HQW1YLG9Q1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Store modules globally
        window.firebaseModules = {
            collection,
            query,
            where,
            onSnapshot,
            getDocs
        };
        window.db = db;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;

        console.log('‚úÖ Firebase initialized for debugging');
    </script>

    <script>
        // Wait for Firebase to be ready
        function waitForFirebase() {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.firebaseModules && window.db && window.auth) {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        // Mock getFilters function (simplified version of the main one)
        function getFilters() {
            const filters = {};

            // Text filters
            const stanowisko = document.getElementById('filterStanowisko')?.value;
            const firma = document.getElementById('filterFirma')?.value;
            const status = window.filters?.status || '';

            if (stanowisko) filters.stanowisko = stanowisko;
            if (firma) filters.firma = firma;
            if (status) filters.status = status;

            // Date filters
            const dateType = document.getElementById('filterDateType')?.value;
            const dateFieldType = document.getElementById('filterDateFieldType')?.value || 'application';

            if (dateType === 'exact') {
                const data = document.getElementById('filterData')?.value;
                if (data) {
                    filters.data = data;
                    filters.dateFieldType = dateFieldType;
                }
            } else if (dateType === 'range') {
                const dateFrom = document.getElementById('filterDateFrom')?.value;
                const dateTo = document.getElementById('filterDateTo')?.value;
                if (dateFrom) {
                    filters.dateFrom = dateFrom;
                    filters.dateFieldType = dateFieldType;
                }
                if (dateTo) {
                    filters.dateTo = dateTo;
                    filters.dateFieldType = dateFieldType;
                }
            }

            // Multi-select filters - collect arrays of selected values
            const multiSelectFilters = ['filterTryb', 'filterRodzaj', 'filterUmowa'];

            multiSelectFilters.forEach(filterId => {
                const dropdown = document.getElementById(filterId + 'Dropdown');
                if (dropdown) {
                    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
                    const selectedValues = Array.from(checkboxes).map(cb => cb.value);

                    if (selectedValues.length > 0) {
                        const fieldName = filterId.replace('filter', '').toLowerCase();
                        filters[fieldName] = selectedValues;
                    }
                }
            });

            return filters;
        }

        function normalizeText(text) {
            if (!text) return '';
            return text.toLowerCase()
                .replace(/ƒÖ/g, 'a')
                .replace(/ƒá/g, 'c')
                .replace(/ƒô/g, 'e')
                .replace(/≈Ç/g, 'l')
                .replace(/≈Ñ/g, 'n')
                .replace(/√≥/g, 'o')
                .replace(/≈õ/g, 's')
                .replace(/≈∫/g, 'z')
                .replace(/≈º/g, 'z');
        }

        // Test if an application matches current filters
        function testApplicationMatch(app, filters) {
            let match = true;
            const reasons = [];

            for (const key in filters) {
                if (filters[key]) {
                    // Special handling for "Rozmowy" status filter
                    if (key === 'status' && filters[key] === 'Rozmowy') {
                        const interviewStatuses = ['Rozmowa telefoniczna', 'Rozmowa online', 'Rozmowa stacjonarna'];
                        if (!interviewStatuses.includes(app.status)) {
                            match = false;
                            reasons.push(`Status "${app.status}" doesn't match "Rozmowy" filter`);
                            break;
                        }
                    }
                    // Special handling for "Odrzucono" status filter
                    else if (key === 'status' && filters[key] === 'Odrzucono') {
                        const rejectedVariants = ['odrzucono', 'odrzucony', 'odrzucona', 'odrzucone'];
                        if (!app.status || !rejectedVariants.some(v => app.status.toLowerCase().includes(v))) {
                            match = false;
                            reasons.push(`Status "${app.status}" doesn't match "Odrzucono" filter`);
                            break;
                        }
                    }
                    // Special handling for other status filters
                    else if (key === 'status' && filters[key] === 'Wys≈Çano CV') {
                        if (normalizeText(app.status) !== 'wyslano cv') {
                            match = false;
                            reasons.push(`Status "${app.status}" doesn't match "Wys≈Çano CV" filter`);
                            break;
                        }
                    }
                    else if (key === 'status' && filters[key] === 'Oferty') {
                        if (!app.status || !normalizeText(app.status).includes('oferta')) {
                            match = false;
                            reasons.push(`Status "${app.status}" doesn't match "Oferty" filter`);
                            break;
                        }
                    } else if (Array.isArray(filters[key])) {
                        // Handle multi-select filters (arrays)
                        const multiSelectFields = ['tryb', 'rodzaj', 'umowa'];
                        if (multiSelectFields.includes(key) && filters[key].length > 0) {
                            if (!filters[key].includes(app[key])) {
                                match = false;
                                reasons.push(`${key} "${app[key]}" not in selected values: [${filters[key].join(', ')}]`);
                                break;
                            }
                        }
                    } else if (typeof app[key] === "string" && typeof filters[key] === "string") {
                        // For exact match fields like rodzaj, umowa, tryb - use strict equality
                        const exactMatchFields = ['rodzaj', 'umowa', 'tryb'];
                        if (exactMatchFields.includes(key)) {
                            if (app[key] !== filters[key]) {
                                match = false;
                                reasons.push(`${key} "${app[key]}" doesn't exactly match "${filters[key]}"`);
                                break;
                            }
                        } else {
                            // For text fields like stanowisko, firma - use includes
                            if (!app[key]?.toLowerCase().includes(filters[key].toLowerCase())) {
                                match = false;
                                reasons.push(`${key} "${app[key]}" doesn't contain "${filters[key]}"`);
                                break;
                            }
                        }
                    } else if (key === 'dateFrom') {
                        // Handle date range "from" filter
                        if (filters[key]) {
                            let compareDate;
                            if (filters.dateFieldType === 'status' && app.statusHistory && app.statusHistory.length > 0) {
                                const lastStatus = app.statusHistory[app.statusHistory.length - 1];
                                compareDate = lastStatus.date || app.data;
                            } else {
                                compareDate = app.data;
                            }

                            const appDate = new Date(compareDate);
                            const filterDate = new Date(filters[key]);
                            if (appDate < filterDate) {
                                match = false;
                                reasons.push(`Date ${compareDate} is before ${filters[key]}`);
                                break;
                            }
                        }
                    } else if (key === 'dateTo') {
                        // Handle date range "to" filter
                        if (filters[key]) {
                            let compareDate;
                            if (filters.dateFieldType === 'status' && app.statusHistory && app.statusHistory.length > 0) {
                                const lastStatus = app.statusHistory[app.statusHistory.length - 1];
                                compareDate = lastStatus.date || app.data;
                            } else {
                                compareDate = app.data;
                            }

                            const appDate = new Date(compareDate);
                            const filterDate = new Date(filters[key]);
                            if (appDate > filterDate) {
                                match = false;
                                reasons.push(`Date ${compareDate} is after ${filters[key]}`);
                                break;
                            }
                        }
                    } else if (key === 'data') {
                        // Handle exact date filter
                        if (filters[key]) {
                            let compareDate;
                            if (filters.dateFieldType === 'status' && app.statusHistory && app.statusHistory.length > 0) {
                                const lastStatus = app.statusHistory[app.statusHistory.length - 1];
                                compareDate = lastStatus.date || app.data;
                            } else {
                                compareDate = app.data;
                            }

                            if (compareDate !== filters[key]) {
                                match = false;
                                reasons.push(`Date ${compareDate} doesn't match ${filters[key]}`);
                                break;
                            }
                        }
                    } else if (filters[key] && app[key] != filters[key]) {
                        match = false;
                        reasons.push(`${key} "${app[key]}" doesn't match "${filters[key]}"`);
                        break;
                    }
                }
            }

            return { match, reasons };
        }

        function checkCurrentFilters() {
            const output = document.getElementById('quickTestOutput');
            output.style.display = 'block';
            output.className = 'debug-output info';

            try {
                // Try to access parent window's filter functions
                let filters = {};

                if (window.parent && window.parent !== window) {
                    // We're in an iframe, try to access parent
                    try {
                        if (window.parent.getFilters) {
                            filters = window.parent.getFilters();
                        }
                    } catch (e) {
                        console.log('Cannot access parent window filters:', e.message);
                    }
                }

                // Also check global window filters
                if (window.filters) {
                    filters = { ...filters, ...window.filters };
                }

                const result = `Current Filters Check:
===================

Filter Object:
${JSON.stringify(filters, null, 2)}

Filter Analysis:
- Number of active filters: ${Object.keys(filters).length}
- Has text filters: ${!!(filters.stanowisko || filters.firma)}
- Has status filter: ${!!filters.status}
- Has date filters: ${!!(filters.data || filters.dateFrom || filters.dateTo)}
- Has multi-select filters: ${!!(filters.tryb || filters.rodzaj || filters.umowa)}

Potential Issues:
${Object.keys(filters).length === 0 ? '‚úÖ No filters active - all applications should show' : '‚ö†Ô∏è Filters are active - new applications must match these criteria'}

Filter Details:
${Object.entries(filters).map(([key, value]) => `- ${key}: ${Array.isArray(value) ? `[${value.join(', ')}]` : value}`).join('\\n')}`;

                output.textContent = result;

                // Also update the filter analysis section
                document.getElementById('filterAnalysis').textContent = result;

            } catch (error) {
                output.className = 'debug-output error';
                output.textContent = `Error checking filters: ${error.message}`;
            }
        }

        function simulateNewApplication() {
            const output = document.getElementById('quickTestOutput');
            output.style.display = 'block';
            output.className = 'debug-output info';

            // Create a sample new application with today's date
            const today = new Date().toISOString().split('T')[0];
            const sampleApp = {
                stanowisko: 'Frontend Developer',
                firma: 'Test Company',
                data: today,
                status: 'Wys≈Çano CV',
                tryb: 'Zdalnie',
                rodzaj: 'PELNY_ETAT',
                umowa: 'UMOWA_O_PRACE',
                wynagrodzenie: '8000',
                waluta: 'PLN',
                wynRodzaj: 'brutto',
                favorite: false,
                archiwalna: false
            };

            // Get current filters (from parent window if possible)
            let filters = {};
            if (window.parent && window.parent.getFilters) {
                try {
                    filters = window.parent.getFilters();
                } catch (e) {
                    console.log('Cannot access parent filters');
                }
            }

            const matchResult = testApplicationMatch(sampleApp, filters);

            const result = `Simulate New Application Test:
================================

Sample Application:
${JSON.stringify(sampleApp, null, 2)}

Current Filters:
${JSON.stringify(filters, null, 2)}

Match Test Result:
- Would show in table: ${matchResult.match ? '‚úÖ YES' : '‚ùå NO'}
- Reasons for not showing: ${matchResult.reasons.length > 0 ? matchResult.reasons.join(', ') : 'None'}

Recommendation:
${matchResult.match ?
                    '‚úÖ A new application like this should appear in the table immediately.' :
                    '‚ö†Ô∏è A new application like this would be HIDDEN by current filters!\\n\\nTo see new applications, either:\\n1. Clear all filters, or\\n2. Ensure your filters match new application properties'
                }`;

            output.textContent = result;
            document.getElementById('matchingTest').textContent = result;
        }

        function testApplicationMatching() {
            const output = document.getElementById('quickTestOutput');
            output.style.display = 'block';
            output.className = 'debug-output info';

            // Test multiple application scenarios
            const testCases = [
                {
                    name: 'Basic Application',
                    app: {
                        stanowisko: 'JavaScript Developer',
                        firma: 'Tech Corp',
                        data: '2025-06-17',
                        status: 'Wys≈Çano CV',
                        tryb: 'Hybrydowo',
                        rodzaj: 'PELNY_ETAT',
                        umowa: 'UMOWA_O_PRACE'
                    }
                },
                {
                    name: 'Remote Application',
                    app: {
                        stanowisko: 'React Developer',
                        firma: 'Remote Co',
                        data: '2025-06-16',
                        status: 'Rozmowa telefoniczna',
                        tryb: 'Zdalnie',
                        rodzaj: 'PELNY_ETAT',
                        umowa: 'UMOWA_B2B'
                    }
                },
                {
                    name: 'Rejected Application',
                    app: {
                        stanowisko: 'Vue Developer',
                        firma: 'Old Company',
                        data: '2025-06-10',
                        status: 'Odrzucono',
                        tryb: 'Stacjonarnie',
                        rodzaj: 'NIEPELNY_ETAT',
                        umowa: 'UMOWA_ZLECENIE'
                    }
                }
            ];

            let filters = {};
            if (window.parent && window.parent.getFilters) {
                try {
                    filters = window.parent.getFilters();
                } catch (e) {
                    console.log('Cannot access parent filters');
                }
            }

            const results = testCases.map(testCase => {
                const matchResult = testApplicationMatch(testCase.app, filters);
                return {
                    name: testCase.name,
                    match: matchResult.match,
                    reasons: matchResult.reasons
                };
            });

            const result = `Application Matching Test:
=========================

Current Filters:
${JSON.stringify(filters, null, 2)}

Test Results:
${results.map(r =>
                `- ${r.name}: ${r.match ? '‚úÖ PASS' : '‚ùå FAIL'}${r.reasons.length > 0 ? ` (${r.reasons.join(', ')})` : ''}`
            ).join('\\n')}

Summary:
- Applications that would show: ${results.filter(r => r.match).length}/${results.length}
- Applications that would be hidden: ${results.filter(r => !r.match).length}/${results.length}

${results.filter(r => !r.match).length > 0 ?
                    '‚ö†Ô∏è Some applications would be hidden by current filters!' :
                    '‚úÖ All test applications would be visible with current filters!'
                }`;

            output.textContent = result;
            document.getElementById('matchingTest').textContent = result;
        }

        async function checkRealTimeListener() {
            const output = document.getElementById('quickTestOutput');
            output.style.display = 'block';
            output.className = 'debug-output info';

            try {
                await waitForFirebase();

                const user = window.auth.currentUser;
                if (!user) {
                    output.className = 'debug-output error';
                    output.textContent = 'Error: User not authenticated. Please log in first.';
                    return;
                }

                output.textContent = 'Checking real-time listener...\n\nUser ID: ' + user.uid + '\n\nSetting up test listener...';

                const q = window.firebaseModules.query(
                    window.firebaseModules.collection(window.db, "applications"),
                    window.firebaseModules.where("userId", "==", user.uid)
                );

                let listenerCount = 0;
                const startTime = Date.now();

                const unsubscribe = window.firebaseModules.onSnapshot(q, (querySnapshot) => {
                    listenerCount++;
                    const endTime = Date.now();

                    const result = `Real-time Listener Test:
========================

‚úÖ Listener Status: WORKING
üìä Listener call #${listenerCount}
‚è±Ô∏è Response time: ${endTime - startTime}ms
üìÑ Applications found: ${querySnapshot.size}
üîÑ From cache: ${querySnapshot.metadata.fromCache}
üìù Has pending writes: ${querySnapshot.metadata.hasPendingWrites}

Applications found:
${querySnapshot.docs.map((doc, i) => {
                        const app = doc.data();
                        return `${i + 1}. ${app.stanowisko} at ${app.firma} (${app.data}) - ${app.status}`;
                    }).join('\\n')}

‚úÖ Real-time listener is working correctly!
New applications should appear automatically when added.`;

                    output.textContent = result;
                    document.getElementById('listenerStatus').textContent = result;

                    // Unsubscribe after first response
                    if (listenerCount === 1) {
                        setTimeout(() => unsubscribe(), 1000);
                    }
                }, (error) => {
                    output.className = 'debug-output error';
                    output.textContent = `‚ùå Real-time listener error: ${error.message}`;
                    document.getElementById('listenerStatus').textContent = `‚ùå Real-time listener error: ${error.message}`;
                });

            } catch (error) {
                output.className = 'debug-output error';
                output.textContent = `Error testing real-time listener: ${error.message}`;
            }
        }

        function clearAllAndTest() {
            const output = document.getElementById('quickTestOutput');
            output.style.display = 'block';
            output.className = 'debug-output info';

            try {
                // Try to clear filters in parent window
                if (window.parent && window.parent.clearAllFilters) {
                    window.parent.clearAllFilters();
                    output.textContent = '‚úÖ Cleared all filters in main application.\n\nNow try adding a new application - it should appear immediately.';
                } else {
                    output.className = 'debug-output warning';
                    output.textContent = '‚ö†Ô∏è Cannot access parent window to clear filters.\n\nPlease manually clear all filters in the main application and try adding a new application.';
                }
            } catch (error) {
                output.className = 'debug-output error';
                output.textContent = `Error clearing filters: ${error.message}`;
            }
        }

        // Auto-run basic checks when page loads
        window.addEventListener('load', async () => {
            try {
                await waitForFirebase();

                // Wait for auth state
                window.onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        console.log('‚úÖ User authenticated, ready for debugging');
                        checkCurrentFilters();
                    } else {
                        console.log('‚ùå User not authenticated');
                        document.getElementById('quickTestOutput').style.display = 'block';
                        document.getElementById('quickTestOutput').className = 'debug-output error';
                        document.getElementById('quickTestOutput').textContent = '‚ùå User not authenticated. Please log in to the main application first.';
                    }
                });

            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });
    </script>
</body>

</html>