<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Test Real-time Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Test Real-time Application Updates</h1>

        <div class="test-section info">
            <h3>Status aplikacji</h3>
            <p id="appStatus">Sprawdzanie...</p>
            <button onclick="checkStatus()">Od≈õwie≈º status</button>
            <button onclick="openMainApp()">Otw√≥rz g≈Ç√≥wnƒÖ aplikacjƒô</button>
        </div>

        <div class="test-section">
            <h3>Testy Real-time</h3>
            <button onclick="testAddApplication()">Test: Dodaj aplikacjƒô</button>
            <button onclick="checkListener()">Sprawd≈∫ listener</button>
            <button onclick="simulateRefresh()">Symuluj od≈õwie≈ºenie</button>
        </div>

        <div class="test-section">
            <h3>Debug Log</h3>
            <button onclick="clearLog()">Wyczy≈õƒá log</button>
            <div id="debugLog" class="log">Rozpoczƒôcie test√≥w...\n</div>
        </div>

        <div class="test-section">
            <h3>Instrukcje</h3>
            <ol>
                <li>Upewnij siƒô, ≈ºe jeste≈õ zalogowany w g≈Ç√≥wnej aplikacji</li>
                <li>Kliknij "Test: Dodaj aplikacjƒô" - otworzy siƒô nowe okno</li>
                <li>Dodaj aplikacjƒô w nowym oknie</li>
                <li>Sprawd≈∫ czy aplikacja pojawia siƒô automatycznie w g≈Ç√≥wnym oknie</li>
                <li>Je≈õli nie, u≈ºyj przycisku "Sprawd≈∫ listener"</li>
            </ol>
        </div>
    </div>

    <script>
        let mainAppWindow = null;

        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = 'Log wyczyszczony...\n';
        }

        function checkStatus() {
            log('Sprawdzanie statusu aplikacji...');

            // Sprawd≈∫ czy g≈Ç√≥wne okno jest otwarte
            if (mainAppWindow && !mainAppWindow.closed) {
                log('‚úÖ G≈Ç√≥wne okno aplikacji jest otwarte', 'success');

                // Sprawd≈∫ status listenera w g≈Ç√≥wnym oknie
                try {
                    if (mainAppWindow.checkListenerStatus) {
                        const status = mainAppWindow.checkListenerStatus();
                        log(`üì° Status listenera: ${JSON.stringify(status)}`);
                    } else {
                        log('‚ö†Ô∏è Funkcja checkListenerStatus niedostƒôpna w g≈Ç√≥wnym oknie', 'error');
                    }
                } catch (e) {
                    log(`‚ùå B≈ÇƒÖd podczas sprawdzania statusu: ${e.message}`, 'error');
                }
            } else {
                log('‚ùå G≈Ç√≥wne okno aplikacji nie jest otwarte', 'error');
                mainAppWindow = null;
            }

            document.getElementById('appStatus').textContent = mainAppWindow && !mainAppWindow.closed ?
                'G≈Ç√≥wna aplikacja otwarta' : 'G≈Ç√≥wna aplikacja zamkniƒôta';
        }

        function openMainApp() {
            log('Otwieranie g≈Ç√≥wnej aplikacji...');
            mainAppWindow = window.open('index.html', '_blank');

            setTimeout(() => {
                checkStatus();
            }, 2000);
        }

        function testAddApplication() {
            log('Test dodawania aplikacji...');

            if (!mainAppWindow || mainAppWindow.closed) {
                log('‚ùå Najpierw otw√≥rz g≈Ç√≥wnƒÖ aplikacjƒô!', 'error');
                return;
            }

            // Otw√≥rz stronƒô dodawania aplikacji
            const addWindow = window.open('add-application.html', '_blank');
            log('‚úÖ Otwarto okno dodawania aplikacji');

            // Monitoruj czy okno zosta≈Ço zamkniƒôte (co mo≈ºe oznaczaƒá, ≈ºe aplikacja zosta≈Ça dodana)
            const checkClosed = setInterval(() => {
                if (addWindow.closed) {
                    clearInterval(checkClosed);
                    log('üîÑ Okno dodawania zosta≈Ço zamkniƒôte - sprawdzanie g≈Ç√≥wnego okna...');

                    setTimeout(() => {
                        if (mainAppWindow && !mainAppWindow.closed) {
                            log('üì° Sprawdzanie czy nowa aplikacja pojawi≈Ça siƒô w tabeli...');
                            // Tutaj mo≈ºna dodaƒá wiƒôcej logiki sprawdzania
                        }
                    }, 1000);
                }
            }, 1000);
        }

        function checkListener() {
            log('Sprawdzanie statusu real-time listenera...');

            if (!mainAppWindow || mainAppWindow.closed) {
                log('‚ùå G≈Ç√≥wne okno aplikacji nie jest otwarte', 'error');
                return;
            }

            try {
                if (mainAppWindow.checkListenerStatus) {
                    const status = mainAppWindow.checkListenerStatus();
                    log(`üìä Status listenera: ${JSON.stringify(status, null, 2)}`);

                    if (status.hasListener && status.isAuthenticated && status.hasFirebase) {
                        log('‚úÖ Real-time listener dzia≈Ça poprawnie', 'success');
                    } else {
                        log('‚ö†Ô∏è Problem z real-time listenerem:', 'error');
                        if (!status.hasListener) log('  - Brak aktywnego listenera');
                        if (!status.isAuthenticated) log('  - U≈ºytkownik niezalogowany');
                        if (!status.hasFirebase) log('  - Brak modu≈Ç√≥w Firebase');
                    }
                } else {
                    log('‚ùå Funkcja checkListenerStatus niedostƒôpna', 'error');
                }
            } catch (e) {
                log(`‚ùå B≈ÇƒÖd: ${e.message}`, 'error');
            }
        }

        function simulateRefresh() {
            log('Symulowanie od≈õwie≈ºenia aplikacji...');

            if (!mainAppWindow || mainAppWindow.closed) {
                log('‚ùå G≈Ç√≥wne okno aplikacji nie jest otwarte', 'error');
                return;
            }

            try {
                if (mainAppWindow.refreshApplications) {
                    mainAppWindow.refreshApplications();
                    log('‚úÖ Wywo≈Çano refreshApplications w g≈Ç√≥wnym oknie', 'success');
                } else {
                    log('‚ùå Funkcja refreshApplications niedostƒôpna', 'error');
                }
            } catch (e) {
                log(`‚ùå B≈ÇƒÖd podczas od≈õwie≈ºania: ${e.message}`, 'error');
            }
        }

        // Sprawd≈∫ status przy za≈Çadowaniu strony
        window.addEventListener('load', () => {
            log('üöÄ Test real-time rozpoczƒôty');
            checkStatus();
        });
    </script>
</body>

</html>