<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug - Dodaj Aplikacjƒô</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .debug-log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
        }

        .log-info {
            color: #007bff;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-warning {
            color: #ffc107;
        }

        #form-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Debug - Dodaj Aplikacjƒô</h1>
        <p>Ta wersja zawiera rozszerzone logowanie do debugowania problemu z dodawaniem aplikacji.</p>

        <div class="debug-log" id="debugLog">
            <div class="log-entry log-info">Debug rozpoczƒôty...</div>
        </div>

        <div id="auth-status" style="margin: 20px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;">
            Sprawdzanie autoryzacji...
        </div>

        <form id="addApplicationForm">
            <div class="form-group">
                <label for="stanowisko">Stanowisko *</label>
                <input type="text" id="stanowisko" name="stanowisko" required>
            </div>

            <div class="form-group">
                <label for="firma">Firma *</label>
                <input type="text" id="firma" name="firma" required>
            </div>

            <div class="form-group">
                <label for="data">Data aplikowania *</label>
                <input type="date" id="data" name="data" required>
            </div>

            <div class="form-group">
                <label for="status">Status *</label>
                <select id="status" name="status" required>
                    <option value="">Wybierz status...</option>
                    <option value="Wys≈Çano CV">Wys≈Çano CV</option>
                    <option value="Rozmowa telefoniczna">Rozmowa telefoniczna</option>
                    <option value="Rozmowa online">Rozmowa online</option>
                    <option value="Rozmowa stacjonarna">Rozmowa stacjonarna</option>
                    <option value="Oferta">Oferta</option>
                    <option value="Odrzucono">Odrzucono</option>
                </select>
            </div>

            <div class="form-group">
                <label for="salaryMode">Typ wynagrodzenia</label>
                <select id="salaryMode" name="salaryMode">
                    <option value="single">Pe≈Çna kwota</option>
                    <option value="range">Wide≈Çki (od-do)</option>
                </select>
            </div>

            <div class="form-group" id="salarySingle">
                <label for="wynagrodzenie">Wynagrodzenie</label>
                <input type="number" id="wynagrodzenie" name="wynagrodzenie" min="0" step="any" placeholder="np. 8000">
            </div>

            <div class="form-group" id="salaryRange" style="display:none;">
                <label for="wynagrodzenieOd">Wynagrodzenie od</label>
                <input type="number" id="wynagrodzenieOd" name="wynagrodzenieOd" min="0" step="any"
                    placeholder="np. 6000">
                <label for="wynagrodzenieDo">Wynagrodzenie do</label>
                <input type="number" id="wynagrodzenieDo" name="wynagrodzenieDo" min="0" step="any"
                    placeholder="np. 10000">
            </div>

            <div class="form-group">
                <label for="waluta">Waluta</label>
                <select id="waluta" name="waluta">
                    <option value="PLN">PLN</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <div class="form-group">
                <label for="wynRodzaj">Rodzaj wynagrodzenia</label>
                <select id="wynRodzaj" name="wynRodzaj">
                    <option value="BRUTTO">BRUTTO</option>
                    <option value="NETTO">NETTO</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tryb">Tryb pracy *</label>
                <select id="tryb" name="tryb" required>
                    <option value="">Wybierz tryb...</option>
                    <option value="STACJONARNY">Stacjonarny</option>
                    <option value="HYBRYDOWY">Hybrydowy</option>
                    <option value="ZDALNY">Zdalny</option>
                </select>
            </div>

            <div class="form-group">
                <label for="rodzaj">Rodzaj *</label>
                <select id="rodzaj" name="rodzaj" required>
                    <option value="">Wybierz rodzaj...</option>
                    <option value="PELNY_ETAT">Pe≈Çny etat</option>
                    <option value="NIEPELNY_ETAT">Niepe≈Çny etat</option>
                    <option value="STAZ">Sta≈º</option>
                </select>
            </div>

            <div class="form-group">
                <label for="umowa">Umowa *</label>
                <select id="umowa" name="umowa" required>
                    <option value="">Wybierz umowƒô...</option>
                    <option value="UMOWA_O_PRACE">Umowa o pracƒô</option>
                    <option value="UMOWA_B2B">Umowa B2B</option>
                    <option value="UMOWA_ZLECENIE">Umowa zlecenie</option>
                </select>
            </div>

            <div class="form-group">
                <label for="kontakt">Kontakt</label>
                <input type="text" id="kontakt" name="kontakt" placeholder="email lub telefon">
            </div>

            <div class="form-group">
                <label for="link">Link do oferty</label>
                <input type="url" id="link" name="link" placeholder="https://">
            </div>

            <div class="form-group">
                <label for="notatki">Notatki</label>
                <textarea id="notatki" name="notatki" rows="3" placeholder="Dodatkowe informacje..."></textarea>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="favorite"> Oznacz jako ulubionƒÖ
                </label>
            </div>

            <button type="submit">Dodaj aplikacjƒô</button>
            <button type="button" onclick="clearDebugLog()">Wyczy≈õƒá log</button>
            <button type="button" onclick="testFirebaseConnection()">Test Firebase</button>
        </form>

        <div id="form-message"></div>

        <div style="margin-top: 20px;">
            <a href="index.html" style="color: #007bff;">‚Üê Powr√≥t do g≈Ç√≥wnej strony</a>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD7ZLyDHFBNsQe9j03YPi0xmdLbqdk_K68",
            authDomain: "rekrutracker-app.firebaseapp.com",
            projectId: "rekrutracker-app",
            storageBucket: "rekrutracker-app.firebasestorage.app",
            messagingSenderId: "758407291898",
            appId: "1:758407291898:web:a573e2cd3b416596d37a43",
            measurementId: "G-HQW1YLG9Q1"
        };

        // Initialize Firebase
        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Debug logging function
        function debugLog(message, type = 'info') {
            const logContainer = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        window.clearDebugLog = function () {
            document.getElementById('debugLog').innerHTML = '<div class="log-entry log-info">Debug log wyczyszczony...</div>';
        };

        window.testFirebaseConnection = function () {
            debugLog('Testowanie po≈ÇƒÖczenia z Firebase...', 'info');

            // Test auth
            if (auth.currentUser) {
                debugLog(`‚úÖ U≈ºytkownik zalogowany: ${auth.currentUser.email}`, 'success');
                debugLog(`UID: ${auth.currentUser.uid}`, 'info');
            } else {
                debugLog('‚ùå Brak zalogowanego u≈ºytkownika', 'error');
                return;
            }

            // Test Firestore
            try {
                debugLog('Testowanie Firestore...', 'info');
                debugLog(`‚úÖ Firestore po≈ÇƒÖczony`, 'success');
                debugLog(`‚úÖ Collection function dostƒôpny: ${typeof collection}`, 'success');
                debugLog(`‚úÖ addDoc function dostƒôpny: ${typeof addDoc}`, 'success');
                debugLog(`‚úÖ serverTimestamp function dostƒôpny: ${typeof serverTimestamp}`, 'success');
            } catch (error) {
                debugLog(`‚ùå B≈ÇƒÖd Firestore: ${error.message}`, 'error');
            }
        };

        debugLog('Firebase inicjalizowany...', 'info');
        debugLog(`App name: ${app.name}`, 'info');
        debugLog(`Project ID: ${firebaseConfig.projectId}`, 'info');

        // Authentication status
        onAuthStateChanged(auth, function (user) {
            const authStatus = document.getElementById('auth-status');
            if (user) {
                authStatus.innerHTML = `‚úÖ Zalogowany jako: ${user.email}<br>UID: ${user.uid}`;
                authStatus.style.background = '#d4edda';
                debugLog(`‚úÖ U≈ºytkownik zalogowany: ${user.email}`, 'success');
            } else {
                authStatus.innerHTML = '‚ùå Nie zalogowany - przekierowywanie do strony logowania...';
                authStatus.style.background = '#f8d7da';
                debugLog('‚ùå Brak autoryzacji', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        });

        // Salary mode toggle
        document.getElementById('salaryMode').addEventListener('change', function () {
            const mode = this.value;
            const single = document.getElementById('salarySingle');
            const range = document.getElementById('salaryRange');
            single.style.display = mode === 'single' ? 'block' : 'none';
            range.style.display = mode === 'range' ? 'block' : 'none';
            debugLog(`Zmieniono tryb wynagrodzenia na: ${mode}`, 'info');
        });

        // Form submission
        document.getElementById('addApplicationForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            debugLog('=== ROZPOCZƒòCIE DODAWANIA APLIKACJI ===', 'info');

            // Check if user is authenticated
            const user = auth.currentUser;
            if (!user) {
                debugLog('‚ùå Brak autoryzacji', 'error');
                document.getElementById('form-message').textContent = "Musisz byƒá zalogowany!";
                document.getElementById('form-message').style.background = '#f8d7da';
                return;
            }

            debugLog(`‚úÖ U≈ºytkownik: ${user.email} (${user.uid})`, 'success');

            // Get form data
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            debugLog(`üìù Dane formularza:`, 'info');
            debugLog(JSON.stringify(data, null, 2), 'info');

            const salaryMode = document.getElementById('salaryMode').value;
            const wynagrodzenie = document.getElementById('wynagrodzenie').value;
            const wynagrodzenieOd = document.getElementById('wynagrodzenieOd').value;
            const wynagrodzenieDo = document.getElementById('wynagrodzenieDo').value;

            debugLog(`üí∞ Salary mode: ${salaryMode}`, 'info');
            debugLog(`üí∞ Wynagrodzenie: ${wynagrodzenie}`, 'info');
            debugLog(`üí∞ Wynagrodzenie od: ${wynagrodzenieOd}`, 'info');
            debugLog(`üí∞ Wynagrodzenie do: ${wynagrodzenieDo}`, 'info');

            // Validation for salary fields
            if (salaryMode === 'single' && (!wynagrodzenie || wynagrodzenie.trim() === '')) {
                debugLog('‚ùå Brak wynagrodzenia dla trybu single', 'error');
                document.getElementById('form-message').textContent = "Pole wynagrodzenie jest wymagane!";
                document.getElementById('form-message').style.background = '#f8d7da';
                return;
            } else if (salaryMode === 'range' && (!wynagrodzenieOd || !wynagrodzenieDo)) {
                debugLog('‚ùå Brak wide≈Çek dla trybu range', 'error');
                document.getElementById('form-message').textContent = "Wype≈Çnij oba pola wide≈Çek!";
                document.getElementById('form-message').style.background = '#f8d7da';
                return;
            }

            debugLog('‚úÖ Walidacja przesz≈Ça pomy≈õlnie', 'success');

            try {
                debugLog('üîÑ Przygotowywanie danych do zapisu...', 'info');

                const applicationData = {
                    stanowisko: data.stanowisko,
                    firma: data.firma,
                    data: data.data,
                    status: data.status,
                    tryb: data.tryb,
                    rodzaj: data.rodzaj,
                    umowa: data.umowa,
                    waluta: data.waluta,
                    wynRodzaj: data.wynRodzaj,
                    salaryMode: salaryMode,
                    statusHistory: [{
                        status: data.status,
                        date: data.data
                    }],
                    archiwalna: false,
                    favorite: document.getElementById('favorite').checked,
                    userId: user.uid,
                    createdAt: serverTimestamp()
                };

                // Add salary fields
                if (salaryMode === 'single' && wynagrodzenie) {
                    applicationData.wynagrodzenie = parseFloat(wynagrodzenie);
                    debugLog(`üí∞ Dodano wynagrodzenie: ${wynagrodzenie}`, 'info');
                } else if (salaryMode === 'range') {
                    if (wynagrodzenieOd) applicationData.wynagrodzenieOd = parseFloat(wynagrodzenieOd);
                    if (wynagrodzenieDo) applicationData.wynagrodzenieDo = parseFloat(wynagrodzenieDo);
                    debugLog(`üí∞ Dodano wide≈Çki: ${wynagrodzenieOd}-${wynagrodzenieDo}`, 'info');
                }

                // Add optional fields
                if (data.kontakt) applicationData.kontakt = data.kontakt;
                if (data.link) applicationData.link = data.link;
                if (data.notatki) applicationData.notatki = data.notatki;

                debugLog('üìÑ Finalne dane aplikacji:', 'info');
                debugLog(JSON.stringify(applicationData, null, 2), 'info');

                debugLog('üîÑ Zapisywanie do Firestore...', 'info');
                const docRef = await addDoc(collection(db, "applications"), applicationData);
                debugLog(`‚úÖ Aplikacja zapisana z ID: ${docRef.id}`, 'success');

                document.getElementById('form-message').textContent = "‚úÖ Aplikacja zosta≈Ça dodana pomy≈õlnie!";
                document.getElementById('form-message').style.background = '#d4edda';

                debugLog('‚úÖ Formularz zostanie zresetowany za 2 sekundy', 'success');

                setTimeout(() => {
                    this.reset();
                    debugLog('üîÑ Przekierowanie na stronƒô g≈Ç√≥wnƒÖ...', 'info');
                    window.location.href = "index.html";
                }, 2000);

            } catch (error) {
                debugLog(`‚ùå B≈ÅƒÑD podczas zapisu: ${error.message}`, 'error');
                debugLog(`‚ùå Stack trace: ${error.stack}`, 'error');
                console.error("Szczeg√≥≈Çy b≈Çƒôdu:", error);

                document.getElementById('form-message').textContent = `‚ùå B≈ÇƒÖd: ${error.message}`;
                document.getElementById('form-message').style.background = '#f8d7da';
            }
        });

        debugLog('‚úÖ Skrypt za≈Çadowany pomy≈õlnie', 'success');
    </script>
</body>

</html>